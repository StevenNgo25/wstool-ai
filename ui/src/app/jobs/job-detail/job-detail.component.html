<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">Chi tiết công việc</h1>
    <div>
      <button class="btn btn-outline-warning me-2" 
              (click)="restartJob()"
              [disabled]="job?.status === 'Running' || job?.status === 'Pending'">
        <i class="fa fa-refresh me-1"></i>Khởi động lại
      </button>
      <button class="btn btn-outline-danger" 
              (click)="cancelJob()"
              [disabled]="job?.status === 'Completed' || job?.status === 'Failed' || job?.status === 'Cancelled'">
        <i class="fa fa-ban me-1"></i>Hủy công việc
      </button>
    </div>
  </div>

  <app-loading *ngIf="loading" height="400px" message="Đang tải chi tiết công việc..."></app-loading>

  <div class="card shadow mb-4" *ngIf="job && !loading">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">Thông tin công việc</h6>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <p><strong>Tên công việc:</strong> {{ job.name }}</p>
          <p><strong>Mô tả:</strong> {{ job.description || 'Không có' }}</p>
          <p><strong>Loại công việc:</strong> {{ job.jobType }}</p>
          <p><strong>Tin nhắn:</strong> {{ job.messageTitle }}</p>
          <p><strong>Tài khoản WhatsApp:</strong> {{ job.instanceName }}</p>
        </div>
        <div class="col-md-6">
          <p><strong>Trạng thái:</strong> <span [ngClass]="getJobStatusClass(job.status)">{{ job.status }}</span></p>
          <p><strong>Tiến độ:</strong> {{ job.progress }}%</p>
          <p><strong>Ngày tạo:</strong> {{ job.createdAt | date:'short' }}</p>
          <p><strong>Hẹn giờ đăng:</strong> {{ job.scheduledAt ? (job.scheduledAt | date:'short') : 'Chạy ngay lập tức' }}</p>
          <p><strong>Bắt đầu lúc:</strong> {{ job.startedAt ? (job.startedAt | date:'short') : 'Không có' }}</p>
          <p><strong>Hoàn thành lúc:</strong> {{ job.completedAt ? (job.completedAt | date:'short') : 'Không có' }}</p>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-12">
          <p><strong>Nhóm mục tiêu:</strong> 
            <span *ngIf="job.assignedGroups && job.assignedGroups.length > 0">
              <span *ngFor="let group of job.assignedGroups" class="badge bg-secondary me-1">{{ group.name }}</span>
            </span>
            <span *ngIf="!job.assignedGroups || job.assignedGroups.length === 0">Không có</span>
          </p>
          <p><strong>Số điện thoại mục tiêu:</strong> 
            <span *ngIf="job.targetPhoneNumbers && job.targetPhoneNumbers.length > 0">
              {{ job.targetPhoneNumbers.join(', ') }}
            </span>
            <span *ngIf="!job.targetPhoneNumbers || job.targetPhoneNumbers.length === 0">Không có</span>
          </p>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow mb-4" *ngIf="job && !loading">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">Nhật ký công việc</h6>
    </div>
    <div class="card-body" style="height: 300px; overflow-y: auto;">
      <div *ngIf="job.logs && job.logs.length > 0; else noLogs">
        <ul class="list-group list-group-flush">
          <li class="list-group-item" *ngFor="let log of job.logs">
            <small class="text-muted">{{ log.createdAt }}</small>
            <span class="ms-2" [ngClass]="getLogLevelClass(log.logLevel)">
              <strong>[{{ log.logLevel }}]</strong>
            </span>
            <p class="mb-0">{{ log.message }}</p>
          </li>
        </ul>
      </div>
      <ng-template #noLogs>
        <div class="text-center text-muted py-4">Không có nhật ký cho công việc này.</div>
      </ng-template>
    </div>
  </div>

  <div class="card shadow" *ngIf="job && !loading">
    <div class="card-header py-3">
      <h6 class="m-0 font-weight-bold text-primary">Tin nhắn đã gửi</h6>
    </div>
    <div class="card-body" style="height: 300px; overflow-y: auto;">
      <div *ngIf="job.sentMessages && job.sentMessages.length > 0; else noSentMessages">
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light">
              <tr>
                <th>Người nhận</th>
                <th>Trạng thái</th>
                <th>Thời gian gửi</th>
                <th>Lỗi</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let sentMsg of job.sentMessages">
                <td>{{ sentMsg.recipientId }}</td>
                <td>
                  <span class="badge" 
                        [ngClass]="{
                          'bg-success': sentMsg.status === 'Sent',
                          'bg-danger': sentMsg.status === 'Failed'
                        }">
                    {{ sentMsg.status === 'Sent' ? 'Đã gửi' : 'Thất bại' }}
                  </span>
                </td>
                <td>{{ sentMsg.sentAt | date:'short' }}</td>
                <td>{{ sentMsg.errorMessage || 'Không có' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <ng-template #noSentMessages>
        <div class="text-center text-muted py-4">Chưa có tin nhắn nào được gửi cho công việc này.</div>
      </ng-template>
    </div>
  </div>
</div>
